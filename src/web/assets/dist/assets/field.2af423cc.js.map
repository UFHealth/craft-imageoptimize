{"version":3,"file":"field.2af423cc.js","sources":["../../../../../buildchain/src/js/OptimizedImagesField.js"],"sourcesContent":["/* global $ */\n/* global Craft */\n/* global Garnish */\n\n/**\n * Image Optimize plugin for Craft CMS\n *\n * OptimizedImages Field JS\n *\n * @author    nystudio107\n * @copyright Copyright (c) 2017 nystudio107\n * @link      https://nystudio107.com\n * @package   ImageOptimize\n * @since     1.2.0\n */\n\n/**\n * Convert the passed in bytes into a human readable format\n *\n * @param bytes\n * @param si\n * @param dp\n * @returns {string}\n */\nfunction humanFileSize(bytes, si=false, dp=1) {\n    const thresh = si ? 1000 : 1024;\n\n    if (Math.abs(bytes) < thresh) {\n        return bytes + ' B';\n    }\n\n    const units = si\n        ? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']\n        : ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];\n    let u = -1;\n    const r = 10**dp;\n\n    do {\n        bytes /= thresh;\n        ++u;\n    } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);\n\n\n    return bytes.toFixed(dp) + ' ' + units[u];\n}\n\n/**\n * After an image has loaded, query the performance API for the decodedBodySize\n *\n * @param image\n */\nfunction imageLoaded(image) {\n    const url = image.src || image.href;\n    if (url && url.length > 0) {\n        const iTime = performance.getEntriesByName(url)[0];\n        if (iTime !== undefined) {\n            const elem = image.parentNode.parentNode.parentNode.nextElementSibling.querySelector('.io-file-size');\n            if (elem) {\n                elem.innerHTML = humanFileSize(iTime.decodedBodySize, true);\n            }\n        }\n    }\n}\n\n(function ( $, window, document) {\n\n    const pluginName = \"ImageOptimizeOptimizedImages\",\n        defaults = {\n        };\n\n    // Plugin constructor\n    function Plugin( element, options ) {\n        this.element = element;\n\n        this.options = $.extend( {}, defaults, options) ;\n\n        this._defaults = defaults;\n        this._name = pluginName;\n\n        this.init();\n    }\n\n    Plugin.prototype = {\n\n        init: function() {\n            $(function () {\n\n                /* -- _this.options gives us access to the $jsonVars that our FieldType passed down to us */\n\n                const images = document.querySelectorAll(\"img.io-preview-image\");\n                for (const image of images) {\n                    if (image.complete) {\n                        imageLoaded(image);\n                    } else {\n                        image.addEventListener('load', (event) => {\n                            imageLoaded(event.target);\n                        });\n                    }\n                }\n            });\n        }\n    };\n\n    // A really lightweight plugin wrapper around the constructor,\n    // preventing against multiple instantiations\n    $.fn[pluginName] = function ( options ) {\n        return this.each(function () {\n            if (!$.data(this, \"plugin_\" + pluginName)) {\n                $.data(this, \"plugin_\" + pluginName,\n                    new Plugin( this, options ));\n            }\n        });\n    };\n\n})($, window, document);\n\nCraft.OptimizedImagesInput = Garnish.Base.extend(\n    {\n        id: null,\n        inputNamePrefix: null,\n        inputIdPrefix: null,\n\n        $container: null,\n        $blockContainer: null,\n        $addBlockBtnContainer: null,\n        $addBlockBtnGroup: null,\n        $addBlockBtnGroupBtns: null,\n\n        blockSort: null,\n        blockSelect: null,\n\n        init: function(id, inputNamePrefix) {\n\n            this.id = id;\n            this.inputNamePrefix = inputNamePrefix;\n            this.inputIdPrefix = Craft.formatInputId(this.inputNamePrefix);\n\n            this.$container = $('#' + this.id);\n            this.$blockContainer = this.$container.children('.variant-blocks');\n            this.$addBlockBtnContainer = this.$container.children('.buttons');\n            this.$addBlockBtnGroup = this.$addBlockBtnContainer.children('.btngroup');\n            this.$addBlockBtnGroupBtns = this.$addBlockBtnGroup.children('.btn');\n\n            // Create our action button menus\n            this.$blockContainer.find('> > .actions > .settings').each( (index, value) => {\n                const $value = $(value);\n                let menuBtn;\n                if ($value.data('menubtn')) {\n                    menuBtn = $value.data('menubtn');\n                } else {\n                    menuBtn = new Garnish.MenuBtn(value);\n                }\n                menuBtn.menu.settings.onOptionSelect = $.proxy(function(option) {\n                    this.onMenuOptionSelect(option, menuBtn);\n                }, this);\n            });\n\n            const $blocks = this.$blockContainer.children();\n\n            this.blockSort = new Garnish.DragSort($blocks, {\n                handle: '> .actions > .move',\n                axis: 'y',\n                collapseDraggees: true,\n                magnetStrength: 4,\n                helperLagBase: 1.5,\n                helperOpacity: 0.9,\n                onSortChange: $.proxy(function() {\n                    this.resetVariantBlockOrder();\n                }, this)\n            });\n\n            this.addListener(this.$addBlockBtnGroupBtns, 'click', function() {\n                this.addVariantBlock(null);\n            });\n\n            this.addAspectRatioHandlers();\n            this.reIndexVariants();\n        },\n\n        onMenuOptionSelect: function(option, menuBtn) {\n            const $option = $(option);\n            const container = menuBtn.$btn.closest('.matrixblock');\n\n            switch ($option.data('action')) {\n                case 'add': {\n                    this.addVariantBlock(container);\n                    break;\n                }\n                case 'delete': {\n                    if (!$option.hasClass('disabled')) {\n                        this.deleteVariantBlock(container);\n                    }\n                    break;\n                }\n            }\n        },\n\n        getHiddenBlockCss: function($block) {\n            return {\n                opacity: 0,\n                marginBottom: -($block.outerHeight())\n            };\n        },\n\n        // Re-index all of the variant blocks\n        reIndexVariants: function() {\n            this.$blockContainer = this.$container.children('.variant-blocks');\n            const $blocks = this.$blockContainer.children();\n            $blocks.each(function (index, value) {\n                const variantIndex = index;\n                const $value = $(value);\n                const elements = $value.find('div .field, label, input, select');\n\n                // Re-index all of the element attributes\n                $(elements).each(function (index, value) {\n                    // id attributes\n                    let str = $(value).attr('id');\n                    if (str) {\n                        str = str.replace(/-([0-9]+)-/g, \"-\" + variantIndex +\"-\");\n                        $(value).attr('id', str);\n                    }\n                    // for attributes\n                    str = $(value).attr('for');\n                    if (str) {\n                        str = str.replace(/-([0-9]+)-/g, \"-\" + variantIndex +\"-\");\n                        $(value).attr('for', str);\n                    }\n                    // Name attributes\n                    str = $(value).attr('name');\n                    if (str) {\n                        str = str.replace(/\\[([0-9]+)]/g, \"[\" + variantIndex +\"]\");\n                        $(value).attr('name', str);\n                    }\n                });\n            });\n            let disabledDeleteItem = false;\n            // If we only have one block, don't allow it to be deleted\n            if ($blocks.length == 1) {\n                disabledDeleteItem = true;\n            }\n            $blocks.find('> .actions > .settings').each(function (index, value) {\n                const $value = $(value);\n                let menuBtn;\n                if ($value.data('menubtn')) {\n                    menuBtn = $value.data('menubtn');\n                    let menuItem = $(menuBtn.menu.$menuList[1]);\n                    if (typeof menuItem !== undefined) {\n                        if (disabledDeleteItem) {\n                            menuItem.find(\"> li > a\").addClass('disabled').disable();\n                        } else {\n                            menuItem.find(\"> li > a\").removeClass('disabled').enable();\n                        }\n                    }\n                }\n            });\n        },\n\n        addAspectRatioHandlers: function () {\n            this.addListener($('.lightswitch'), 'click', function(ev) {\n                const $target = $(ev.target);\n                const $block = $target.closest('.matrixblock');\n                $block.find('.io-aspect-ratio-wrapper').slideToggle();\n            });\n            this.addListener($('.io-select-ar-box'), 'click', function(ev) {\n                const $target = $(ev.target);\n                let x = $(ev.target).data('x'),\n                    y = $(ev.target).data('y'),\n                    custom = $(ev.target).data('custom'),\n                    field, $block;\n                // Select the appropriate aspect ratio\n                $block = $target.closest('.matrixblock');\n                $block.find('.io-select-ar-box').each(function (index, value) {\n                    $(value).removeClass('io-selected-ar-box');\n                });\n                $target.addClass('io-selected-ar-box');\n\n                // Handle setting the actual field values\n                if (custom) {\n                    $block.find('.io-custom-ar-wrapper').slideDown();\n                } else {\n                    $block.find('.io-custom-ar-wrapper').slideUp();\n                    field = $block.find('input')[2];\n                    $(field).val(x);\n                    field = $block.find('input')[3];\n                    $(field).val(y);\n                }\n            });\n        },\n\n        addVariantBlock: function(container) {\n            let $block = $(this.$blockContainer.children()[0]).clone();\n            // Reset to default values\n            $block.find('.io-select-ar-box').each( (index, value) => {\n                if (index === 0) {\n                    $(value).addClass('io-selected-ar-box');\n                } else {\n                    $(value).removeClass('io-selected-ar-box');\n                }\n            });\n            $block.find('.io-custom-ar-wrapper').hide();\n            let field = $block.find('input')[0];\n            $(field).val(1200);\n            field = $block.find('input')[1];\n            $(field).val(1);\n            field = $block.find('input')[2];\n            $(field).val(16);\n            field = $block.find('input')[3];\n            $(field).val(9);\n            field = $block.find('select')[0];\n            $(field).val(82);\n            field = $block.find('select')[1];\n            $(field).val('jpg');\n            $block.css(this.getHiddenBlockCss($block)).velocity({\n                opacity: 1,\n                'margin-bottom': 10\n            }, 'fast', $.proxy(function() {\n                // Insert the block in the right place\n                if (container) {\n                    $block.insertBefore(container);\n                } else {\n                    $block.appendTo(this.$blockContainer);\n                }\n                // Update the Garnish UI controls\n                this.blockSort.addItems($block);\n                this.addAspectRatioHandlers();\n                $block.find('.settings').each( (index, value) => {\n                    let $value = $(value),\n                        menuBtn,\n                        menu;\n\n                    menu = this.$container.find('.io-menu-clone > .menu').clone();\n                    $(menu).insertAfter($value);\n                    menuBtn = new Garnish.MenuBtn(value);\n\n                    menuBtn.menu.settings.onOptionSelect = $.proxy(function(option) {\n                        this.onMenuOptionSelect(option, menuBtn);\n                    }, this);\n                });\n                this.reIndexVariants();\n            }, this));\n        },\n\n        deleteVariantBlock: function(container) {\n            container.velocity(this.getHiddenBlockCss(container), 'fast', $.proxy( () => {\n                container.remove();\n                this.reIndexVariants();\n            }, this));\n        },\n\n        resetVariantBlockOrder: function() {\n            this.reIndexVariants();\n        }\n    });\n"],"names":[],"mappings":"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"}