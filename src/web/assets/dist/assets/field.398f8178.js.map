{"version":3,"file":"field.398f8178.js","sources":["../../src/js/OptimizedImagesField.js"],"sourcesContent":["/* global $ */\n/* global Craft */\n/* global Garnish */\n\n/**\n * Image Optimize plugin for Craft CMS\n *\n * OptimizedImages Field JS\n *\n * @author    nystudio107\n * @copyright Copyright (c) 2017 nystudio107\n * @link      https://nystudio107.com\n * @package   ImageOptimize\n * @since     1.2.0\n */\n\n/**\n * Convert the passed in bytes into a human readable format\n *\n * @param bytes\n * @param si\n * @param dp\n * @returns {string}\n */\nfunction humanFileSize(bytes, si = false, dp = 1) {\n  const thresh = si ? 1000 : 1024;\n\n  if (Math.abs(bytes) < thresh) {\n    return bytes + ' B';\n  }\n\n  const units = si\n    ? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']\n    : ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];\n  let u = -1;\n  const r = 10 ** dp;\n\n  do {\n    bytes /= thresh;\n    ++u;\n  } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);\n\n\n  return bytes.toFixed(dp) + ' ' + units[u];\n}\n\n/**\n * After an image has loaded, query the performance API for the decodedBodySize\n *\n * @param image\n */\nfunction imageLoaded(image) {\n  const url = image.src || image.href;\n  if (url && url.length > 0) {\n    const iTime = performance.getEntriesByName(url)[0];\n    if (typeof iTime !== \"undefined\") {\n      const elem = image.parentNode.parentNode.parentNode.nextElementSibling.querySelector('.io-file-size');\n      if (elem) {\n        elem.innerHTML = humanFileSize(iTime.decodedBodySize, true);\n      }\n    }\n  }\n}\n\n(function ($, window, document) {\n\n  const pluginName = \"ImageOptimizeOptimizedImages\",\n    defaults = {};\n\n  // Plugin constructor\n  function Plugin(element, options) {\n    this.element = element;\n\n    this.options = $.extend({}, defaults, options);\n\n    this._defaults = defaults;\n    this._name = pluginName;\n\n    this.init();\n  }\n\n  Plugin.prototype = {\n\n    init: function () {\n      $(function () {\n\n        /* -- _this.options gives us access to the $jsonVars that our FieldType passed down to us */\n\n        const images = document.querySelectorAll(\"img.io-preview-image\");\n        for (const image of images) {\n          if (image.complete) {\n            imageLoaded(image);\n          } else {\n            image.addEventListener('load', (event) => {\n              imageLoaded(event.target);\n            });\n          }\n        }\n      });\n    }\n  };\n\n  // A really lightweight plugin wrapper around the constructor,\n  // preventing against multiple instantiations\n  $.fn[pluginName] = function (options) {\n    return this.each(function () {\n      if (!$.data(this, \"plugin_\" + pluginName)) {\n        $.data(this, \"plugin_\" + pluginName,\n          new Plugin(this, options));\n      }\n    });\n  };\n\n})($, window, document);\n\nCraft.OptimizedImagesInput = Garnish.Base.extend(\n  {\n    id: null,\n    inputNamePrefix: null,\n    inputIdPrefix: null,\n\n    $container: null,\n    $blockContainer: null,\n    $addBlockBtnContainer: null,\n    $addBlockBtnGroup: null,\n    $addBlockBtnGroupBtns: null,\n\n    blockSort: null,\n    blockSelect: null,\n\n    init: function (id, inputNamePrefix) {\n      this.id = id;\n      this.inputNamePrefix = inputNamePrefix;\n      this.inputIdPrefix = Craft.formatInputId(this.inputNamePrefix);\n\n      this.$container = $('#' + this.id);\n      this.$blockContainer = this.$container.children('.variant-blocks');\n      this.$addBlockBtnContainer = this.$container.children('.buttons');\n      this.$addBlockBtnGroup = this.$addBlockBtnContainer.children('.btngroup');\n      this.$addBlockBtnGroupBtns = this.$addBlockBtnGroup.children('.btn');\n\n      // Create our action button menus\n      this.$blockContainer.find('> > .actions > .settings').each((index, value) => {\n        const $value = $(value);\n        let menuBtn;\n        if ($value.data('menubtn')) {\n          menuBtn = $value.data('menubtn');\n        } else {\n          menuBtn = new Garnish.MenuBtn(value);\n        }\n        menuBtn.menu.settings.onOptionSelect = $.proxy(function (option) {\n          this.onMenuOptionSelect(option, menuBtn);\n        }, this);\n      });\n\n      const $blocks = this.$blockContainer.children();\n\n      this.blockSort = new Garnish.DragSort($blocks, {\n        handle: '> .actions > .move',\n        axis: 'y',\n        collapseDraggees: true,\n        magnetStrength: 4,\n        helperLagBase: 1.5,\n        helperOpacity: 0.9,\n        onSortChange: $.proxy(function () {\n          this.resetVariantBlockOrder();\n        }, this)\n      });\n\n      this.addListener(this.$addBlockBtnGroupBtns, 'click', function () {\n        this.addVariantBlock(null);\n      });\n\n      this.addAspectRatioHandlers();\n      this.reIndexVariants();\n    },\n\n    onMenuOptionSelect: function (option, menuBtn) {\n      const $option = $(option);\n      const container = menuBtn.$btn.closest('.matrixblock');\n\n      switch ($option.data('action')) {\n        case 'add': {\n          this.addVariantBlock(container);\n          break;\n        }\n        case 'delete': {\n          if (!$option.hasClass('disabled')) {\n            this.deleteVariantBlock(container);\n          }\n          break;\n        }\n      }\n    },\n\n    getHiddenBlockCss: function ($block) {\n      return {\n        opacity: 0,\n        marginBottom: -($block.outerHeight())\n      };\n    },\n\n    // Re-index all of the variant blocks\n    reIndexVariants: function () {\n      this.$blockContainer = this.$container.children('.variant-blocks');\n      const $blocks = this.$blockContainer.children();\n      $blocks.each(function (index, value) {\n        const variantIndex = index;\n        const $value = $(value);\n        const elements = $value.find('div .field, label, input, select');\n\n        // Re-index all of the element attributes\n        $(elements).each(function (index, value) {\n          // id attributes\n          let str = $(value).attr('id');\n          if (str) {\n            str = str.replace(/-([0-9]+)-/g, \"-\" + variantIndex + \"-\");\n            $(value).attr('id', str);\n          }\n          // for attributes\n          str = $(value).attr('for');\n          if (str) {\n            str = str.replace(/-([0-9]+)-/g, \"-\" + variantIndex + \"-\");\n            $(value).attr('for', str);\n          }\n          // Name attributes\n          str = $(value).attr('name');\n          if (str) {\n            str = str.replace(/\\[([0-9]+)]/g, \"[\" + variantIndex + \"]\");\n            $(value).attr('name', str);\n          }\n        });\n      });\n      let disabledDeleteItem = false;\n      // If we only have one block, don't allow it to be deleted\n      if ($blocks.length == 1) {\n        disabledDeleteItem = true;\n      }\n      $blocks.find('> .actions > .settings').each(function (index, value) {\n        const $value = $(value);\n        let menuBtn;\n        if ($value.data('menubtn')) {\n          menuBtn = $value.data('menubtn');\n          let menuItem = $(menuBtn.menu.$menuList[1]);\n          if (typeof menuItem !== \"undefined\") {\n            if (disabledDeleteItem) {\n              menuItem.find(\"> li > a\").addClass('disabled').disable();\n            } else {\n              menuItem.find(\"> li > a\").removeClass('disabled').enable();\n            }\n          }\n        }\n      });\n    },\n\n    addAspectRatioHandlers: function () {\n      this.addListener($('.lightswitch'), 'click', function (ev) {\n        const $target = $(ev.target);\n        const $block = $target.closest('.matrixblock');\n        $block.find('.io-aspect-ratio-wrapper').slideToggle();\n      });\n      this.addListener($('.io-select-ar-box'), 'click', function (ev) {\n        const $target = $(ev.target);\n        let x = $(ev.target).data('x'),\n          y = $(ev.target).data('y'),\n          custom = $(ev.target).data('custom'),\n          field, $block;\n        // Select the appropriate aspect ratio\n        $block = $target.closest('.matrixblock');\n        $block.find('.io-select-ar-box').each(function (index, value) {\n          $(value).removeClass('io-selected-ar-box');\n        });\n        $target.addClass('io-selected-ar-box');\n\n        // Handle setting the actual field values\n        if (custom) {\n          $block.find('.io-custom-ar-wrapper').slideDown();\n        } else {\n          $block.find('.io-custom-ar-wrapper').slideUp();\n          field = $block.find('input')[2];\n          $(field).val(x);\n          field = $block.find('input')[3];\n          $(field).val(y);\n        }\n      });\n    },\n\n    addVariantBlock: function (container) {\n      let $block = $(this.$blockContainer.children()[0]).clone();\n      // Reset to default values\n      $block.find('.io-select-ar-box').each((index, value) => {\n        if (index === 0) {\n          $(value).addClass('io-selected-ar-box');\n        } else {\n          $(value).removeClass('io-selected-ar-box');\n        }\n      });\n      $block.find('.io-custom-ar-wrapper').hide();\n      let field = $block.find('input')[0];\n      $(field).val(1200);\n      field = $block.find('input')[1];\n      $(field).val(1);\n      field = $block.find('input')[2];\n      $(field).val(16);\n      field = $block.find('input')[3];\n      $(field).val(9);\n      field = $block.find('select')[0];\n      $(field).val(82);\n      field = $block.find('select')[1];\n      $(field).val('jpg');\n      $block.css(this.getHiddenBlockCss($block)).velocity({\n        opacity: 1,\n        'margin-bottom': 10\n      }, 'fast', $.proxy(function () {\n        // Insert the block in the right place\n        if (container) {\n          $block.insertBefore(container);\n        } else {\n          $block.appendTo(this.$blockContainer);\n        }\n        // Update the Garnish UI controls\n        this.blockSort.addItems($block);\n        this.addAspectRatioHandlers();\n        $block.find('.settings').each((index, value) => {\n          let $value = $(value),\n            menuBtn,\n            menu;\n\n          menu = this.$container.find('.io-menu-clone > .menu').clone();\n          $(menu).insertAfter($value);\n          menuBtn = new Garnish.MenuBtn(value);\n\n          menuBtn.menu.settings.onOptionSelect = $.proxy(function (option) {\n            this.onMenuOptionSelect(option, menuBtn);\n          }, this);\n        });\n        this.reIndexVariants();\n      }, this));\n    },\n\n    deleteVariantBlock: function (container) {\n      container.velocity(this.getHiddenBlockCss(container), 'fast', $.proxy(() => {\n        container.remove();\n        this.reIndexVariants();\n      }, this));\n    },\n\n    resetVariantBlockOrder: function () {\n      this.reIndexVariants();\n    }\n  });\n"],"names":[],"mappings":"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"}